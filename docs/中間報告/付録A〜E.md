付録A 実験環境とモデル設定
====================

付録A.1 ハードウェア・ソフトウェア環境  
本研究で実験を行った計算機環境は以下の通りである（代表的構成）。

- OS：Linux 系または macOS  
- プログラミング言語：Python 3 系  
- 主なライブラリ：数値計算・統計処理用ライブラリ（例：pandas，numpy），可視化ライブラリ（例：matplotlib），LLM 用 API クライアントなど  
- 実験は，コマンドラインから実行可能な評価スクリプトと統計解析スクリプトを用いて行った。

付録A.2 使用言語モデル  
本研究では，商用の大規模言語モデル（LLM）を用いて日本語リポグラムの自動生成を行った。

- モデル種別：Chat 形式の大規模言語モデル  
- 提供元：OpenAI  
- 利用時期：2025年11月頃  
- 主なサンプリング設定：
  - 温度（temperature）：0.5（固定）
  - サンプリング戦略（top-p など）：既定値
  - 最大トークン数：API の既定範囲内

付録A.3 実装と前処理・後処理  

- 実装の概要：
  - 文全体を一度に書き換える「oneshot 方式」
  - 文脈とトークン単位の書き換えを組み合わせる「sequential 方式」
- データ前処理：
  - 元コーパス：Tatoeba 由来の日本語例文コーパス
  - ベース文の抽出条件：
    - 文の長さ：20〜60 文字
    - ひらがなまたは漢字を少なくとも 1 文字以上含む
  - 上記条件を満たす文の中からランダムに 200 文を抽出し，ベース文データセットを構築した。
  - このベース文に対し，禁止かなセットを組み合わせて制約付きデータセットを作成した。
- 制約セット：
  - easy（単音禁止）：い，さ，ら
  - medium（行禁止）：あ行（あ・い・う・え・お），か行（か・き・く・け・こ）
  - 各ベース文について，これらの禁止セットのうち実際に表記に現れるもののみを適用し，1 文あたり最大 3 条件まで付与した。
- 制約チェックと指標計算：
  - 禁止かなの検出は読み（カタカナをひらがなに正規化した読み）に基づいて行い，禁止かなが 1 文字でも含まれれば制約違反と判定した。
  - その他の指標（VRR, TTR, n-gram の反復率，処理時間）も専用の関数で自動計算した。


付録B プロンプトテンプレート
=======================

付録B.1 共通ルール（実装準拠）  

実際の実装では，oneshot と sequential で共通のリポグラム規則を，次のような形でプロンプトに挿入している。

> 【日本語リポグラムのルール】  
> ・禁止文字「〔禁止文字の一覧〕」は読み（ひらがな）での使用が禁止されています  
> ・出力全文（または置き換え語句）の読み（ひらがな）に禁止文字が一文字も含まれないこと  
> ・例：「猫」（ねこ）が禁止なら「ネコ科」（ねこか）も「ね」「こ」を含むため禁止です  
> ・文の意味と流れをできるだけ保持し自然な表現に  
> ・句読点や記号はそのままでよい  

ここで，〔禁止文字の一覧〕には「い」「さ」「ら」や「あ・い・う・え・お」「か・き・く・け・こ」などのセットを「、」区切りで埋め込んでいる。

付録B.2 oneshot 方式用プロンプト（実装準拠）  

文全体を一度に書き換える oneshot 方式では，プロンプトは概ね次のような構成である。

> 以下の文章を、日本語リポグラムのルールに従って、  
> 禁止文字『〔禁止文字の一覧〕』を読み（ひらがな）に含まないように  
> 一度で自然に言い換えてください。  
>  
> 【日本語リポグラムのルール】  
> ・禁止文字「〔禁止文字の一覧〕」は読み（ひらがな）での使用が禁止されています  
> ・出力全文（または置き換え語句）の読み（ひらがな）に禁止文字が一文字も含まれないこと  
> ・例：「猫」（ねこ）が禁止なら「ネコ科」（ねこか）も「ね」「こ」を含むため禁止です  
> ・文の意味と流れをできるだけ保持し自然な表現に  
> ・句読点や記号はそのままでよい  
>  
> 【入力】  
> 〔元の文〕  
>  
> 【出力形式】  
> ・説明や引用符を一切付けず、言い換え後の文章のみを出力  

付録B.3 sequential 方式用プロンプト（実装準拠）  

トークン単位での逐次書き換えでは，対象単語ごとに次のようなプロンプトを構築している。

> 以下の単語「〔元の単語〕」は、禁止文字「〔禁止文字の一覧〕」を含むため、  
> 文脈に合った自然な表現に**単語単位**で言い換えてください。  
>  
> 【日本語リポグラムのルール】  
> ・禁止文字「〔禁止文字の一覧〕」は読み（ひらがな）での使用が禁止されています  
> ・出力全文（または置き換え語句）の読み（ひらがな）に禁止文字が一文字も含まれないこと  
> ・例：「猫」（ねこ）が禁止なら「ネコ科」（ねこか）も「ね」「こ」を含むため禁止です  
> ・文の意味と流れをできるだけ保持し自然な表現に  
> ・句読点や記号はそのままでよい  
>  
> 【文脈情報】  
> ・全体の文章：「〔全文〕」  
> ・現在の文：「〔対象単語を含む文〕」  
> ・対象の単語：「〔元の単語〕」  
> ・品詞：「〔品詞〕」  
>  
> 【重要】  
> ・文全体の意味と流れを保持してください  
> ・文法的に自然な表現を選んでください  
> ・特に、変換後の単語の読み（ひらがな）に禁止文字「〔禁止文字の一覧〕」が**一文字も含まれない**こと  

さらに，試行回数に応じて次のような戦略文を追加している。

- 1〜3 回目：  
  「文脈に最も適した同義語や類義語で言い換えてください。」  
- 4〜6 回目：  
  「より広い概念や上位概念で、文の流れを保つ表現を選んでください。」  
- 7 回目以降：  
  「文脈に応じた意訳や、文全体の意味を保つ別の表現方法を試してください。」  

また，これまで失敗した候補がある場合には，

> ・以下の候補は既に試行済みで使用できません：「〔失敗候補の一覧〕」  
> ・これらとは**全く異なる**新しい表現を考えてください。  

という行を追加し，最後に

> ・出力は置き換えた語句 **一単語のみ** にしてください。  
> ・絶対に説明文や補足は付けず、単語だけを出力してください。  

という出力形式の指定を付けている。


付録C 生成例とエラー例
==================

付録C.1 成功例（easy 条件，単音禁止）  

- 元文：  
  「彼がこういうことを言ったのだと思われる。」  
- 条件：  
  禁止かな：い  
  方式：sequential  
  制約タイプ：easy  
- 生成文（例）：  
  「彼がこう述べることを述べたのだと思われる。」  
- コメント：  
  「言った」を「述べた」などに言い換えることで，禁止かな「い」を回避しつつ，元文とほぼ同じ意味を保っている。  
  書き換え率（VRR）は約 0.14 と比較的低く，元文に近い言い換えになっている。

（図C.1：成功例の具体的な入出力例のスクリーンショットを挿入――例文 1 など）

付録C.2 成功例（medium 条件，行禁止）  

- 元文：  
  「彼がこういうことを言ったのだと思われる。」  
- 条件：  
  禁止かなセット：あ・い・う・え・お  
  方式：sequential  
  制約タイプ：medium  
- 生成文（例）：  
  「彼がたしかに述べことを述べたのだと信じれる。」  
- コメント：  
  行禁止条件の下でも，逐次的に禁止トークンを検出して置き換えることで，読みレベルであ行を含まない表現を見つけている。  
  medium 条件における sequential の制約遵守率は，約 86% と高い値を示した。

（図C.2：行禁止条件での成功例の入出力例を挿入――例文 2 など）

付録C.3 失敗例（oneshot，制約違反）  

- 元文：  
  「彼がこういうことを言ったのだと思われる。」  
- 条件：  
  禁止かなセット：あ・い・う・え・お  
  方式：oneshot  
  制約タイプ：medium  
- 生成文（例）：  
  「彼がこうした内容を述べたと推測される。」  
- コメント：  
  表面上は自然な文であり意味も保たれているが，読みレベルであ行の禁止かなが含まれており制約違反となる。  
  medium 条件における oneshot の制約遵守率は約 1.5% と極めて低く，多くの生成がこのタイプの失敗に分類される。

（図C.3：制約違反となった oneshot 生成例の入出力例を挿入）

付録C.4 パターンの概要  

- 成功例では，禁止かなを含む語を同義語や表現の言い換えによって避けるケースが多く見られた。  
- 特に medium 条件では，sequential 方式が複数トークンを段階的に書き換えることで，制約遵守と意味保持を両立している。  
- 失敗例の多くは，oneshot 方式で意味的には適切でも，読みレベルの禁止かなが 1 文字でも残ってしまうパターンであった。


付録D Webアプリケーションの構成と操作手順
===================================

付録D.1 システム構成  

本研究では，バッチ評価に加え，ブラウザ上からリポグラム生成を試せる Web アプリケーションも作成した。主な構成は以下の通りである。

- フロントエンド：  
  入力文，禁止かなセット，生成方式を指定するためのフォームと，生成結果を表示する領域からなる単一ページのインタフェース。
- バックエンド：  
  Python ベースの Web API サーバを用い，  
  入力文・禁止かな・方式を受け取って LLM を呼び出し，生成文と制約遵守フラグなどを返す。
- ログ保存：  
  入力文，禁止かなセット，方式，生成結果，制約違反の有無などを記録し，後続の定量分析やエラー分析に用いた。

（図D.1：Web アプリケーション全体の構成図またはシステム構成図を挿入）

付録D.2 画面構成と操作手順  

- 入力欄：  
  元の日本語文を 1 文入力するテキストボックス。
- 禁止かな欄：  
  禁止するひらがなまたは行（例：い，さ，ら，あ・い・う・え・お など）をカンマ区切りで指定する入力欄。
- 方式選択：  
  oneshot と sequential を選択するラジオボタンまたはプルダウンメニュー。
- 実行ボタン：  
  「生成」ボタンを押すと，指定条件にもとづいてリポグラム文が生成され，結果欄に表示される。
- 結果一覧（任意）：  
  最近の生成結果を表形式で表示し，成功例・失敗例や特徴的な例を容易に確認できるようにした。

（図D.2：Web アプリケーション画面のスクリーンショット（入力欄と結果表示）を挿入）


付録E 統計情報
============

付録E.1 データセットの概要  

- ベース文データセット：
  - 文数：200 文  
  - 文の長さ（文字数）の統計：
    - 平均：約 25.0 文字  
    - 標準偏差：約 5.9 文字  
- 制約付きデータセット：
  - 行数：465 行（約 500 パターン）  
  - 各行は「元文＋禁止かなセット」の組み合わせに対応する。  
  - 制約タイプ別の文数：

    | 制約タイプ | 文数 |
    |------------|------|
    | easy       | 195  |
    | medium     | 270  |

  - 禁止かなセットごとの行数：

    | 禁止かなセット     | 行数 |
    |--------------------|------|
    | あ・い・う・え・お | 160  |
    | い                 | 115  |
    | か・き・く・け・こ | 110  |
    | ら                 | 46   |
    | さ                 | 34   |

付録E.2 制約遵守率（方式 × 制約タイプ）  

制約遵守の成否は，「読みレベルの禁止かなが 1 文字も含まれていないかどうか」に基づいて判定した。  
禁止かなが 1 文字も含まれない生成を「成功」，1 文字以上含む生成を「失敗」と定義する。

- 全体の成功率：

  | 方式       | 成功率   |
  |------------|----------|
  | oneshot    | 約 12.5% |
  | sequential | 約 91.6% |

- 制約タイプ別の成功率：

  | 制約タイプ | 方式       | 成功文数 / 総文数 | 成功率（%） |
  |------------|------------|-------------------|-------------|
  | easy       | oneshot    | 54 / 195          | 約 27.7%    |
  | easy       | sequential | 193 / 195         | 約 99.0%    |
  | medium     | oneshot    | 4 / 270           | 約 1.5%     |
  | medium     | sequential | 233 / 270         | 約 86.3%    |

また，同一の元文・禁止条件の組（計 465 組）について成功/失敗を比較したところ，

- sequential の方が成功（seq > one）：368 組（約 79.1%）  
- 両者同じ（両方成功または両方失敗）：97 組（約 20.9%）  
- oneshot のみ成功（seq < one）：0 組（0%）

という結果となり，制約遵守の観点で sequential が一方的に優位であることが確認された。

（図E.1：方式別の全体成功率の棒グラフを挿入 ―― success_by_method）  
（図E.2：制約タイプ（easy / medium）×方式別成功率の棒グラフを挿入 ―― success_by_constraint_type）

付録E.3 VRR・TTR の記述統計  

語彙の書き換えの程度と多様性を表す指標として，次の 2 つを用いた。

- VRR（Vocabulary Replacement Rate）：  
  元文と生成文のトークン列を比較し，置き換わったトークンの割合を表す指標。
- TTR（Type-Token Ratio）：  
  生成文に含まれるユニークな語の数を総語数で割った値であり，語彙多様性を表す指標。

制約タイプ・方式ごとの平均値と標準偏差は以下の通りである（全生成文を対象とした集計）。

- VRR

  | 制約タイプ | 方式       | 平均 VRR | 標準偏差 |
  |------------|------------|---------:|---------:|
  | easy       | oneshot    | 0.408    | 0.201    |
  | easy       | sequential | 0.117    | 0.061    |
  | medium     | oneshot    | 0.433    | 0.214    |
  | medium     | sequential | 0.225    | 0.100    |

- TTR

  | 制約タイプ | 方式       | 平均 TTR | 標準偏差 |
  |------------|------------|---------:|---------:|
  | easy       | oneshot    | 0.938    | 0.068    |
  | easy       | sequential | 0.921    | 0.087    |
  | medium     | oneshot    | 0.931    | 0.071    |
  | medium     | sequential | 0.918    | 0.083    |

さらに，oneshot と sequential の両方が成功したペア（58 組）に限定して差分を計算したところ，

- VRR 差（sequential − oneshot）：平均約 -0.332  
- TTR 差（sequential − oneshot）：平均約 -0.012  

となり，sequential の方が元文に近い（VRR が低い）一方，語彙多様性（TTR）に関しては大きな差がないことが分かった。

（図E.3：両方式成功ペアにおける VRR の箱ひげ図を挿入 ―― vrr_box_both_success）  
（図E.4：両方式成功ペアにおける VRR–TTR 散布図を挿入 ―― vrr_ttr_scatter_both_success）  
（図E.5：VRR ビンごとの成功率の推移を示すグラフを挿入 ―― success_vs_vrr）

付録E.4 統計的検定の詳細  

本節では，oneshot 方式と sequential 方式の差を統計的に評価するために実施した検定の設定と結果を詳しく述べる。

### (1) 成功率（制約遵守）の比較

- 分析対象：  
  各「元文＋禁止かなセット」の組み合わせごとに，oneshot による生成結果と sequential による生成結果の 2 つが対応する 1 組の観測として得られている（合計 465 組）。
- 変数：  
  成功フラグを，
  - 制約を完全に満たした場合：1  
  - 禁止かなの読みが 1 文字でも含まれる場合：0  
  として数値化した。
- 検定方法：  
  同じ入力条件を共有する 2 方式を比較するため，「対応のある t 検定（paired t-test）」を用いた。  
  各組について差分  
  \[
    d_i = \text{success}_\text{seq, i} - \text{success}_\text{one, i}
  \]  
  を計算し，その平均値が 0 と異なるかどうかを検定した。
- 帰無仮説・対立仮説：  
  - 帰無仮説 \(H_0\)：2 方式の平均成功率に差はない（差分の平均は 0）。  
  - 対立仮説 \(H_1\)：2 方式の平均成功率に差がある（差分の平均は 0 ではない）。
- 結果：  
  - t 値：約 41.96  
  - 自由度：464  
  - p 値：約 5.0 × 10⁻¹⁶⁰  
- 解釈：  
  p 値が極めて小さいため，通常用いられる有意水準（1%，5% 等）ではいずれも帰無仮説を棄却できる。  
  すなわち，「oneshot と sequential の制約遵守率には統計的に有意な差がある」と結論づけられる。  
  実際には，sequential の成功率は約 91.6%，oneshot は約 12.5% であり，差の向きとしては「sequential が一貫して高い成功率を示す」。

### (2) VRR（語彙置換率）の比較

- 分析対象：  
  oneshot と sequential の両方式がともに成功した組（制約違反のない組）に限定して比較した（該当組数は 58 組）。
- 変数：  
  各方式について VRR（Vocabulary Replacement Rate）を算出し，元文のトークン列と生成文のトークン列を比較して「置き換わったトークンの割合」を指標とした。
- 検定方法：  
  成功した 58 組について，対応のある t 検定を行った。  
  差分  
  \[
    d_i = \text{VRR}_\text{seq, i} - \text{VRR}_\text{one, i}
  \]  
  を計算し，その平均が 0 かどうかを検定した。
- 帰無仮説・対立仮説：  
  - \(H_0\)：2 方式の平均 VRR に差はない。  
  - \(H_1\)：2 方式の平均 VRR に差がある。
- 結果：  
  - t 値：約 -13.74  
  - 自由度：57  
  - p 値：約 9.8 × 10⁻²⁰  
  - 差分の平均：おおよそ -0.33（sequential − oneshot）
- 解釈：  
  p 値が非常に小さいため，平均 VRR に有意な差があると判断される。  
  差分の符号が負であることから，「成功したケースに限っても，oneshot の方が VRR が高く（より大きく言い換える），sequential は元文に近い表現を保持しやすい」という傾向が統計的に裏付けられた。

### (3) TTR（語彙多様性）の比較

- 分析対象：  
  VRR と同様に，両方式とも成功した 58 組のみを対象とした。
- 変数：  
  各方式について TTR（Type-Token Ratio）を算出した。TTR は，生成文に含まれるユニークな語の数を総語数で割った値であり，語彙の多様性を表す。
- 検定方法：  
  成功した 58 組について，対応のある t 検定を行った。  
  差分  
  \[
    d_i = \text{TTR}_\text{seq, i} - \text{TTR}_\text{one, i}
  \]  
  を用いて，平均が 0 かどうかを検定した。
- 帰無仮説・対立仮説：  
  - \(H_0\)：2 方式の平均 TTR に差はない。  
  - \(H_1\)：2 方式の平均 TTR に差がある。
- 結果：  
  - t 値：約 -1.40  
  - 自由度：57  
  - p 値：約 0.17  
- 解釈：  
  p 値が 0.05 より大きいため，通常の有意水準では帰無仮説を棄却できない。  
  したがって，「oneshot と sequential の間で，語彙多様性（TTR）の平均値に統計的に有意な差があるとは言えない」と解釈される。  
  実際の差分の平均はわずかに負であるが，その差は偶然変動の範囲内とみなされる。

### (4) まとめ

- 成功率（制約遵守）については，sequential が oneshot を大きく上回っており，対応のある t 検定でも極めて有意な差が確認された。  
- 成功ケースに限定した VRR の比較では，oneshot の方が有意に高いことから，「成功さえすれば oneshot の方が大胆な言い換えを行う」一方で，「sequential は元文に近い表現を保ちやすい」ことが示唆される。  
- TTR については有意差が確認されず，語彙の多様性そのものは 2 方式で大きくは変わらないという結論になった。  

これらの結果から，制約遵守率の観点では sequential が圧倒的に優位であり，言い換えの強さ（VRR）と語彙多様性（TTR）の関係から，両方式の性質の違いを定量的に示すことができた。
