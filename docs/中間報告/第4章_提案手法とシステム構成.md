# 第4章 提案手法とシステム構成

本章では、日本語リポグラム生成のために構築したシステム全体の構成と、LLM を用いた生成手法の概要、さらにそれを利用者がブラウザから操作できるようにする Web アプリケーションの実装概要について述べる。

## 4.1 リポグラム生成フレームワークの概要

本研究で用いるリポグラム生成フレームワークは、入力文と禁止文字集合を受け取り、制約チェック・生成・再書き換えを組み合わせてリポグラム文を生成するパイプラインとして実装されている。中心的なコンポーネントは、文全体を書き換える一発生成方式（oneshot）と、文・トークン単位で逐次的に書き換える逐次生成方式（sequential）を切り替え可能なリライトモジュールであり、いずれの方式でもプロンプト内で禁止かなとリポグラムのルールを明示的に提示し、「説明なしで書き換え後の文のみを出力する」ように LLM に指示している。

制約チェックは、文字ベースと読みベースの二段階で行う。まず表記上の文字列に禁止かなが含まれるかを確認し、次に形態素解析で得られた読みをひらがなに正規化した上で、禁止かなが含まれるかを判定する。これにより、漢字表記の揺れをまたいだ検査が可能になる。生成結果が制約を満たさない場合には、再生成や局所的な修正を行うことで、制約遵守率の向上を図っている。

これら一連の処理の流れを図4.1に示す。図4.1では、入力文と禁止文字集合から始まり、前処理・制約チェックを経て、一発生成方式（oneshot）と逐次生成方式（sequential）の二つの経路に分岐し、再度の制約チェックを通じて最終的なリポグラム文を出力するまでのパイプライン構造を表している。

## 4.2 oneshot/sequential の実装上の違い

第3章では、oneshot と sequential という二つの生成方式の役割を概念的に整理した。本節では、その違いが実装上どのような設計の差として現れているかに焦点を当てる。両方式の主な違いを表4.1に整理する。

一発生成方式（oneshot）では、元文と禁止文字集合をまとめて LLM に入力し、1回の応答で全文をリポグラム文に書き換える。プロンプトには、禁止かなを読みレベルで一切含めないこと、原文の意味を大きく損なわないこと、日本語として自然な文とすることなどを明示し、出力形式を「書き換え後の文のみ」に限定する。制約違反が検出された場合には、全文を対象とした再生成を行う以外に細かな介入がしづらく、生成プロセスは基本的に「一回勝負」の設計となっている。

逐次生成方式（sequential）では、まず元文を文単位に分割し、各文を形態素解析によってトークン列に変換する。そのうえで、表記または読みが禁止かなを含むトークンを検出し、それらをターゲットとして局所的な書き換えを行う。  
　次に、検出された各禁止トークンについて、小さな書き換えループを回す。文全体や前後のトークンなどの文脈情報を含むプロンプトを組み立て、「この部分だけを禁止かなを含まない形に言い換える」ように LLM に指示し、その出力に対して制約チェックを行う。もし生成結果にまだ禁止かなが残っている場合は、プロンプトの条件を段階的に緩めながら再生成を行う。具体的には、元の語に近い同義語、意味的に近い上位概念、より自由度の高い意訳といった方向に少しずつ探索範囲を広げ、あらかじめ定めた最大試行回数の範囲で制約を満たす候補を探索する。このように sequential は、文全体を再生成するのではなく、問題箇所に対して段階的に介入する設計になっており、その分 API コール数と処理時間が増える一方で、制約遵守のための制御自由度が高いという特徴を持つ。

## 4.3 Web アプリケーション実装

リポグラム生成手法の検証と並行して、本研究ではブラウザ上から日本語リポグラムを生成・比較できる Web アプリケーションを開発した。これは、研究者自身がコマンドラインからスクリプトを実行するだけでなく、非専門家や評価協力者が容易にリポグラムを体験できる環境を整備することを目的としている。また、将来的に主観評価実験（可読性・意味保持・自然さの評価）を行う際のインタフェースとしても利用することを想定している。

Web アプリの基本的な機能は、(1) 入力文と禁止文字集合の指定、(2) 生成方式（oneshot / sequential）の選択、(3) 生成結果の表示と比較、の三つに整理できる。ユーザはブラウザ上のテキストボックスに元文を入力し、カンマ区切りで禁止ひらがなを指定することで、アプリ側に生成リクエストを送信する。裏側では、リポグラム生成フレームワークを呼び出して LLM による書き換えを行い、その結果を画面に返す。画面上では、元文・禁止文字・生成文が並べて表示されるため、どの文字が避けられているか、意味や文体がどのように変化したかを直感的に確認できる。

図4.2に Web アプリケーションの全体構成を示す。図4.2 に示すように、アプリは大きく、ブラウザ上の UI、生成ロジックを担うアプリケーション部分、LLM API との連携およびログ記録を行う層の三つに分けて考えることができる。この構成により、一括評価用のコードとロジックを共有しつつ、インタラクティブな利用や将来の主観評価実験の実装を容易にしている。

Web アプリ化の意義は、単に「動くデモ」を提供することにとどまらない。第一に、研究者自身がさまざまな文や制約パターンを即座に試せるようになったことで、エラー事例や興味深い挙動を迅速に発見できるようになった。たとえば、禁止助詞を含む文や、読み制約が厳しい条件に対して、どのような迂回表現が生成されるかを、コードを書き換えなくても探索できる。第二に、今後予定している主観評価実験の基盤として、Web インタフェースがそのまま利用できる。参加者にブラウザから oneshot と sequential の出力を並べて提示し、どちらが読みやすいか・意味が保たれているかを評価してもらう、といったプロトコルを構築しやすい。第三に、ログとして入力・出力・制約・モデル設定を一括して保存することで、後から定量分析やエラー分析に活用できる。

現時点では、Web アプリは研究室内での利用を想定した開発段階にあり、認証やスケーラビリティ対策などは最小限に留めている。一方で、リポグラム生成に必要な基本操作一式は実装されており、中間報告の段階で「リポグラム生成手法の試作だけでなく、利用可能なツールとしての形も見えてきている」ことを示すことができる。今後は、出力結果に対してその場で主観評価ラベルを付与できる UI や、複数候補の一括比較機能などを追加することで、分析軸との統合をさらに進める予定である。
