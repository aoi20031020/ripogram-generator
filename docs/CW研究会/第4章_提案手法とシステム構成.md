# 第4章 提案手法とシステム構成

本章では、日本語リポグラム生成のために構築したフレームワークの全体像と、oneshot / sequential の具体的な手法、およびそれらをブラウザから利用可能にする Web アプリケーションの構成について述べる。

## 4.1 全体フレームワーク概要

本研究で用いるリポグラム生成フレームワークは、入力文と禁止文字集合を受け取り、制約チェックと書き換え処理を組み合わせてリポグラム文を生成するパイプラインとして実装されている。中心的なコンポーネントは、文全体を書き換える一発生成方式（oneshot）と、文やトークン単位で逐次的に書き換える逐次生成方式（sequential）であり、同じフレームワーク内で切り替えられるようになっている。

sequential 方式では、まず元の文を文単位・トークン単位に分割し、それぞれの表記と読みが禁止文字を含んでいるかどうかをチェックする。禁止文字を含むトークンが見つかった場合に限って、そのトークンを対象に LLM による言い換えを行い、置き換え候補が禁止文字を含まないかどうかを再度チェックする、という処理を繰り返す。一方、oneshot 方式は元文全体を一度に LLM に入力して書き換えた後で、その結果に対して制約チェックを行う方式であり、事前のトークン単位の違反検出は行わない。いずれの方式でも、プロンプト内で禁止かなとリポグラムのルールを明示的に提示し、「説明なしで書き換え後の文のみを出力する」ように指示している点は共通である。

本研究では、文の分割や読み取得のために形態素解析を用いる。形態素解析自体は CRF に基づく日本語形態素解析の枠組み（Kudo ら, 2004）に沿った解析器を利用し、実装では Python から扱いやすいラッパ（fugashi）を用いてトークン列と読みを取得している。

## 4.2 oneshot 手法

一発生成方式（oneshot）では、元文と禁止文字集合 \(B\) をまとめて LLM に入力し、1回の応答で全文をリポグラム文に書き換える。プロンプトには、「指定された禁止かなを読みレベルで一切含めないこと」「元文の意味を大きく損なわないこと」「日本語として自然な文とすること」などを明示し、出力形式を「書き換え後の文のみ」に限定する。

この方式の長所は、処理が単純で高速であり、実装も比較的容易な点にある。一方で、禁止文字が1〜2文字だけ残ってしまうケースが多く、とくに行禁止のような厳しい制約下では制約遵守率が低くなる傾向がある。また、生成過程に細かく介入しづらいため、失敗した場合には全文の再生成に頼らざるを得ない。

## 4.3 sequential 手法

逐次生成方式（sequential）では、まず元文を文単位に分割し、各文を形態素解析によってトークン列に変換する。そのうえで、各トークンの表記と読みを調べ、どちらか一方でも禁止かなを含むトークンを検出する。

禁止トークンが見つかった場合には、そのトークンをターゲットとして LLM による言い換えを行う。このとき、対象トークンを含む文（current_sentence）と元の文全体（full_text）を文脈としてプロンプトに含めることで、文脈に沿った自然な代替表現を生成できるようにする。生成された候補語についても、表記と読みが禁止かなを含まないかを再度チェックし、条件を満たさない場合は失敗履歴を更新しながら、あらかじめ定めた回数の範囲で再試行を行う。

このように sequential は、文全体をまとめて再生成するのではなく、「禁止文字を含むトークンが見つかった箇所にだけ局所的に介入する」設計になっている。そのため API コール数と処理時間は増える一方で、必要な箇所に集中的に書き換えを行えることから、oneshot より高い制約遵守率が期待できる。

## 4.4 制約チェックの仕組み

制約チェックでは、各トークンについて「表記」と「読み」の両方に禁止かなが含まれているかを調べる。表記については、表層文字列に禁止かなが含まれていないかを単純に確認し、読みについては、形態素解析器から得られたカナ読みをひらがなに正規化したうえで、同様に禁止かなの有無を判定する。いずれか一方にでも禁止かなが含まれていれば、そのトークンは制約違反とみなされ、sequential 手法の書き換え対象となる。

このように、表記ベースと読みベースの双方で制約を確認することで、漢字・カタカナ・ひらがなの表記揺れをまたいだ検査が可能になり、「表記を変えても読みとしては同じ禁止音を含んでいる」といったケースも検出できる。

## 4.5 Webアプリケーションのシステム構成（図1）

リポグラム生成手法の検証と並行して、本研究ではブラウザ上から日本語リポグラムを生成・比較できる Web アプリケーションを開発した。これは、研究者自身がコマンドラインからスクリプトを実行するだけでなく、評価協力者や非専門家が容易にリポグラムを体験できる環境を整備することを目的としている。

システム構成は、ブラウザ（フロントエンド）、生成ロジックを担うアプリケーション層、LLM API との連携およびログ記録を行う層の三つに大別できる。ユーザはブラウザ上のフォームに元文と禁止ひらがな集合を入力し、oneshot / sequential のどちらか、あるいは両方を選択して生成を実行する。サーバ側では、第4.1節で述べたフレームワークを呼び出し、生成文と制約遵守状況を計算してから結果を返す。これらコンポーネント間のデータフローを図1に示す。

画面上では、元文・禁止文字・各方式の生成文が並べて表示されるため、どの文字が避けられているか、意味や文体がどのように変化したかを直感的に確認できる。また、入力・出力・制約・モデル設定をログとして保存することで、後からの定量分析やエラー分析にも活用できる。将来的には、この Web アプリを主観評価実験のインタフェースとして用い、oneshot と sequential の出力を並べて提示し、可読性や意味保持について人手評価を収集することを計画している。

（図1: 日本語リポグラム Web アプリケーションのシステム構成 ― 中間報告で用いたシステム構成図と同様のレイアウトを、このあたりに配置）
